<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Generate Docs</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootswatch/4.3.1/materia/bootstrap.min.css">
    <style>
        .center-box{
            max-width:400px;
            margin:100px auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card center-box">
            <div class="card-header">
                <h4>Doc Generator</h4>
            </div>
            <div class="card-body">
                    <div class="form-group">
                            <input type="text" class="form-control" id="doc-title" placeholder="Document Title">
                           <p class="float-right"><small class="help-block text-muted">Short title is better</small></p>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="theme" value="light" checked>
                        <label class="form-check-label" for="light">
                          Light Theme
                        </label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="theme" value="dark">
                        <label class="form-check-label" for="dark">
                            Dark Theme
                        </label>
                      </div>
                      <hr>
                    <div class="form-group">
                            <label for="files">Select .md files</label>
                            <input type="file" multiple class="form-control" id="files">
                        </div>
                        <button class="btn btn-success btn-generate">Generate</button>
            </div>
        </div>
    </div>
    <script src="config.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.2.2/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/g/filesaver.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.0/showdown.min.js"></script>
    <script>
    const mdFiles = document.querySelector("#files");
    const docTitle = document.querySelector("#doc-title");
    const btnGenerate = document.querySelector(".btn-generate");

    let files = [];

    const md = new showdown.Converter({tables: true});
    const getFileNames = ()=>{
        for (i = 0; i < mdFiles.files.length; i++) {
            const filename = mdFiles.files[i].name;
            fetch("/md/"+filename).then(e=>e.text()).then(res=>{
                files.push({
                    name:filename.split(".")[0],
                    source:md.makeHtml(res)
                })
            })
        }
    }

    const generateFiles = ()=>{
        if(!docTitle.value){
            alert("Please add document title")
            return;
        }
        let zip = new JSZip();
        const {footer,lightTheme,darkTheme,scriptText} = config;

       const sidebar = config.leftSidebar(docTitle.value,files);
       for(i = 0; i < files.length; i++){
            const {name,source} = files[i];
            const htmlpage = `
            ${config.header(`${docTitle.value} - ${name}`)}
            ${sidebar}
            ${config.mainContent(name,source)}
            ${config.pagination(name,files)}
            ${config.rightSidebar(source)}
            ${footer}
            `;
            zip.file(`${name}.html`, htmlpage);
       }
       const jsFolder = zip.folder("js");
       const cssFolder = zip.folder("css");
       jsFolder.file('main.js', scriptText)
       const theme = document.querySelector('input[name="theme"]:checked').value;
       const styleText = theme == 'dark'?darkTheme:lightTheme;
       cssFolder.file('style.css', styleText);
       zip.generateAsync({type:"blob"})
            .then(function(content) {
                const foldername = Date.now();
                saveAs(content, `doc-${foldername}.zip`);
        });
        
    }

    mdFiles.addEventListener('change',getFileNames)
    btnGenerate.addEventListener('click',generateFiles)
    </script>
</body>
</html>